services:
  prometheus:
    image: prom/prometheus:v2.53.0
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports: ["9090:9090"]

  grafana:
    image: grafana/grafana:10.4.3
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - ./grafana/provisioning/datasources/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
      - ./grafana/provisioning/dashboards/dashboard.yml:/etc/grafana/provisioning/dashboards/dashboard.yml
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    ports: ["3001:3000"]
    depends_on: [ prometheus ]

  db-backup:
    build: ./backup
    environment:
      - DATABASE_URL=postgresql://skinzai:skinzai@db:5432/skinzai
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=minio
      - S3_SECRET_KEY=minio123
      - S3_BUCKET=efolder
    depends_on: [ db ]
    entrypoint: ["bash","-lc","(crontab -l 2>/dev/null; echo '0 2 * * * /app/backup.sh >> /var/log/cron.log 2>&1') | crontab - && cron && tail -f /var/log/cron.log"]
